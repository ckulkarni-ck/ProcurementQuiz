<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Procurement & Supply Chain Quiz</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
  /* General Styles */
  * {
    box-sizing: border-box;
  }
  
  body {
    font-family: 'Roboto', sans-serif;
    margin: 0;
    padding: 0;
    background: #f3f6f8;
    color: #333;
    line-height: 1.6;
  }
  
  .container {
    width: 95%;
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
  }
  
  h1, h2, h3 {
    color: #0073b1;
    text-align: center;
    margin: 15px 0;
  }
  
  h1 {
    font-size: 28px;
    margin-bottom: 25px;
    padding-bottom: 10px;
    border-bottom: 2px solid #0073b1;
  }

  /* Card Styles */
  .card {
    background: #fff;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }

  /* Buttons */
  .btn {
    padding: 15px;
    margin: 8px 0;
    font-size: 16px;
    width: 100%;
    box-sizing: border-box;
    background: #0073b1;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s;
    display: inline-block;
    text-align: center;
    text-decoration: none;
  }
  
  .btn:hover {
    background: #005582;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  
  .btn-secondary {
    background: #e8f0fe;
    color: #0073b1;
    border: 1px solid #0073b1;
  }
  
  .btn-secondary:hover {
    background: #d2e3fc;
  }
  
  .btn-nav {
    width: auto;
    padding: 10px 15px;
    margin: 0 5px;
  }
  
  .btn-question {
    width: 40px;
    height: 40px;
    padding: 0;
    margin: 5px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  
  .btn-answered {
    background: #4caf50;
  }
  
  .btn-current {
    border: 3px solid #0073b1;
  }
  
  .btn-group {
    display: flex;
    gap: 10px;
    margin-top: 15px;
  }
  
  .btn-group .btn {
    flex: 1;
  }

  /* Inputs */
  input[type="email"], input[type="password"] {
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box;
    font-size: 16px;
    transition: border-color 0.3s;
  }
  
  input[type="email"]:focus, input[type="password"]:focus {
    border-color: #0073b1;
    outline: none;
    box-shadow: 0 0 0 2px rgba(0,115,177,0.2);
  }
  
  .input-error {
    border-color: #ff4444;
  }

  /* Hidden Elements */
  .hidden { 
    display: none; 
  }

  /* Quiz and Leaderboard */
  #question-box {
    max-height: 60vh;
    overflow-y: auto;
    padding-right: 10px;
    margin-bottom: 15px;
  }
  
  #question-box p {
    font-size: 18px;
  }
  
  #question-box div {
    margin: 12px 0;
    padding: 10px;
    border-radius: 5px;
    transition: background-color 0.2s;
  }
  
  #question-box div:hover {
    background-color: #f5f5f5;
  }
  
  #question-box input[type="radio"] {
    margin-right: 10px;
    transform: scale(1.2);
  }
  
  #question-box label {
    font-size: 16px;
    cursor: pointer;
  }

  #timer {
    font-weight: bold;
    text-align: right;
    font-size: 18px;
    margin-top: 5px;
    padding: 10px;
    background: #f8f8f8;
    border-radius: 5px;
  }
  
  .timer-warning {
    color: #ff4444;
    animation: pulse 1s infinite;
  }
  
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }

  #question-navigation {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    margin: 15px 0;
    gap: 5px;
  }

  /* Progress Bar */
  .progress-bar {
    height: 10px;
    background: #f0f0f0;
    border-radius: 5px;
    margin: 15px 0;
    overflow: hidden;
  }
  
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #0073b1, #00a0e3);
    border-radius: 5px;
    transition: width 0.3s ease;
  }

  /* Review Section */
  .review-item {
    margin-bottom: 20px;
    padding: 15px;
    border: 1px solid #eee;
    border-radius: 5px;
    background: #fafafa;
  }
  
  .review-correct {
    border-left: 4px solid #4caf50;
  }
  
  .review-incorrect {
    border-left: 4px solid #ff4444;
  }
  
  .review-unanswered {
    border-left: 4px solid #ff9800;
  }

  /* Result Section */
  .score-display {
    font-size: 24px;
    text-align: center;
    margin: 20px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
  }
  
  .share-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    margin: 20px 0;
  }

  /* Leaderboard */
  .leaderboard-item {
    display: flex;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid #eee;
    transition: background-color 0.2s;
  }
  
  .leaderboard-item:hover {
    background-color: #f9f9f9;
  }
  
  .leaderboard-rank {
    width: 40px;
    text-align: center;
    font-weight: bold;
    margin-right: 15px;
    font-size: 18px;
  }
  
  .leaderboard-name {
    flex: 1;
    font-weight: 500;
  }
  
  .leaderboard-score {
    width: 80px;
    text-align: right;
    font-weight: bold;
    color: #0073b1;
  }
  
  .top-three {
    background-color: #f8f9fa;
    border-radius: 8px;
    margin: 5px 0;
  }
  
  .top-three .leaderboard-rank {
    font-size: 24px;
  }

  /* Certificate */
  #certificate-canvas {
    width: 100%;
    height: auto;
    border: 2px solid #333;
    margin: 20px 0;
    border-radius: 10px;
    background: #fff;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  /* Messages */
  #sorry-message {
    font-size: 18px;
    color: #ff4444;
    margin-top: 15px;
    text-align: center;
    padding: 15px;
    background: #fff8f8;
    border-radius: 8px;
    border: 1px solid #ffdddd;
  }

  .error-message {
    color: #ff4444;
    font-size: 14px;
    margin: 5px 0;
  }

  .success-message {
    color: #4caf50;
    font-size: 14px;
    margin: 5px 0;
  }

  /* Loading spinner */
  .spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #0073b1;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
  }
  
  /* Enhanced loading screen */
  .loading-container {
    text-align: center;
    padding: 30px;
  }
  
  .loading-progress {
    height: 6px;
    width: 100%;
    background: #e0e0e0;
    border-radius: 3px;
    margin: 20px 0;
    overflow: hidden;
  }
  
  .loading-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #0073b1, #00a0e3);
    border-radius: 3px;
    width: 0%;
    transition: width 0.5s ease;
  }
  
  .loading-message {
    font-size: 16px;
    color: #666;
    margin-top: 15px;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Footer */
  footer {
    text-align: center;
    margin-top: 30px;
    padding: 20px;
    color: #666;
    font-size: 14px;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .container {
      padding: 15px;
      width: 100%;
    }
    
    h1 {
      font-size: 24px;
    }
    
    h2 {
      font-size: 20px;
    }
    
    .card {
      padding: 20px;
    }
    
    .btn-group {
      flex-direction: column;
    }
    
    .share-buttons {
      grid-template-columns: 1fr;
    }
    
    #question-box p {
      font-size: 16px;
    }
    
    #timer {
      font-size: 16px;
    }
    
    .btn {
      font-size: 15px;
      padding: 12px;
    }
    
    .btn-nav {
      padding: 8px 12px;
    }
  }
</style>
</head>
<body>

<div class="container">
  <h1>Procurement & Supply Chain Quiz</h1>

  <!-- Loading Section -->
  <div id="loading-section" class="hidden">
    <div class="card loading-container">
      <div class="spinner"></div>
      <div class="loading-progress">
        <div class="loading-progress-bar" id="loading-progress-bar"></div>
      </div>
      <p class="loading-message" id="loading-message">Loading, please wait...</p>
    </div>
  </div>

  <!-- Login / Signup Section -->
  <div id="auth-section" class="card">
    <h2>Login / Signup</h2>
    <input type="email" id="email" placeholder="Email" autocomplete="email">
    <input type="password" id="password" placeholder="Password" autocomplete="current-password">
    <div id="confirm-password-container" class="hidden">
      <input type="password" id="confirm-password" placeholder="Confirm Password" autocomplete="new-password">
      <p id="confirm-password-error" class="error-message hidden">Passwords don't match</p>
    </div>
    <p id="password-requirements" class="error-message hidden">Password must be at least 6 characters long</p>
    <button class="btn" id="signup-btn" onclick="toggleSignupMode()">Signup</button>
    <button class="btn" id="login-btn" onclick="login()">Login</button>
    <p id="auth-message"></p>
  </div>

  <!-- Quiz Section -->
  <div id="quiz-section" class="card hidden">
    <h2 id="welcome"></h2>
    
    <div class="progress-bar">
      <div class="progress-fill" id="quiz-progress"></div>
    </div>
    
    <div id="question-navigation"></div>
    
    <div id="question-box"></div>
    
    <div class="btn-group">
      <button class="btn btn-nav" id="prev-btn" onclick="navigateQuestion(-1)">Previous</button>
      <button class="btn btn-nav" id="next-btn" onclick="navigateQuestion(1)">Next</button>
    </div>
    
    <p id="timer"></p>
    <button class="btn" onclick="submitQuiz()">Submit Quiz</button>
  </div>

  <!-- Result Section -->
  <div id="result-section" class="card hidden">
    <h2>Quiz Results</h2>
    <div class="score-display">Your Score: <span id="score"></span></div>
    <canvas id="certificate-canvas" width="800" height="600" class="hidden"></canvas>
    <div id="sorry-message" class="hidden"></div>
    
    <div class="btn-group">
      <button class="btn" id="download-btn" onclick="downloadCertificate()">Download Certificate</button>
      <button class="btn" onclick="retryQuiz()">Retry Quiz</button>
      <button class="btn" id="review-btn" onclick="reviewAnswers()">Review Answers</button>
    </div>

    <h3>Share your achievement:</h3>
    <div class="share-buttons">
      <button class="btn" onclick="shareLinkedIn()">LinkedIn</button>
      <button class="btn" onclick="shareFB()">Facebook</button>
      <button class="btn" onclick="shareTwitter()">Twitter</button>
      <button class="btn" onclick="shareWhatsApp()">WhatsApp</button>
    </div>

    <div id="leaderboard">
      <h3>🏆 Leaderboard (Top 50)</h3>
      <div id="leaderboard-list"></div>
    </div>
  </div>

  <!-- Answers Review Section -->
  <div id="answers-review-section" class="card hidden">
    <h2>Your Answers Review</h2>
    <div id="answers-review-list"></div>
    <button class="btn" onclick="backToResults()">Back to Results</button>
  </div>
</div>

<footer>
  <p>Procurement & Supply Chain Quiz &copy; 2023. All rights reserved.</p>
</footer>

<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyCZa0LpAnvRG3fDL09c3sQ3q0ve5Dbp-AU",
    authDomain: "procurement-qa-game.firebaseapp.com",
    databaseURL: "https://procurement-qa-game-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "procurement-qa-game",
    storageBucket: "procurement-qa-game.firebasestorage.app",
    messagingSenderId: "236805393379",
    appId: "1:236805393379:web:e2f529df8f9967dde82ed6",
    measurementId: "G-85F4PP1SF2"
  };
  
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  let currentUser = null;
  let questions = [];
  let userAnswers = {};
  let currentQuestionIndex = 0;
  let timer;
  let timeLeft = 600; // 10 minutes in seconds
  let isSignupMode = false;

  // DOM Ready
  document.addEventListener('DOMContentLoaded', function() {
    // Check if user is already logged in but don't automatically start quiz
    showLoading(true, "Checking authentication status...");
    auth.onAuthStateChanged(user => {
      showLoading(false);
      if (user) {
        // User is logged in, but we'll keep them at the auth screen
        currentUser = user;
        document.getElementById('email').value = user.email;
        document.getElementById('auth-message').textContent = "You're already logged in. Click Login to continue.";
        document.getElementById('auth-message').className = "success-message";
      }
    });
    
    // Add input validation
    document.getElementById('password').addEventListener('input', validatePassword);
    document.getElementById('confirm-password')?.addEventListener('input', validatePasswordConfirmation);
  });

  // Enhanced loading screen function
  function showLoading(show, message = "Loading, please wait...", progress = 0) {
    const loadingSection = document.getElementById('loading-section');
    const loadingMessage = document.getElementById('loading-message');
    const progressBar = document.getElementById('loading-progress-bar');
    
    if (show) {
      loadingMessage.textContent = message;
      progressBar.style.width = `${progress}%`;
      loadingSection.classList.remove('hidden');
    } else {
      loadingSection.classList.add('hidden');
    }
  }

  // Update loading progress
  function updateLoadingProgress(progress, message) {
    const progressBar = document.getElementById('loading-progress-bar');
    const loadingMessage = document.getElementById('loading-message');
    
    if (progressBar) progressBar.style.width = `${progress}%`;
    if (loadingMessage && message) loadingMessage.textContent = message;
  }

  function toggleSignupMode() {
    isSignupMode = !isSignupMode;
    const signupBtn = document.getElementById('signup-btn');
    const loginBtn = document.getElementById('login-btn');
    const confirmContainer = document.getElementById('confirm-password-container');
    
    if (isSignupMode) {
      signupBtn.textContent = "Signup";
      signupBtn.onclick = signup;
      loginBtn.classList.add('btn-secondary');
      confirmContainer.classList.remove('hidden');
    } else {
      signupBtn.textContent = "Switch to Signup";
      signupBtn.onclick = toggleSignupMode;
      loginBtn.classList.remove('btn-secondary');
      confirmContainer.classList.add('hidden');
    }
  }

  function validatePassword() {
    const password = document.getElementById('password').value;
    const requirements = document.getElementById('password-requirements');
    
    if (password.length > 0 && password.length < 6) {
      requirements.classList.remove('hidden');
      return false;
    } else {
      requirements.classList.add('hidden');
      return true;
    }
  }

  function validatePasswordConfirmation() {
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    const errorElement = document.getElementById('confirm-password-error');
    
    if (confirmPassword && password !== confirmPassword) {
      errorElement.classList.remove('hidden');
      return false;
    } else {
      errorElement.classList.add('hidden');
      return true;
    }
  }

  function validateForm() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    if (!email || !password) {
      document.getElementById('auth-message').textContent = "Please fill in all fields";
      document.getElementById('auth-message').className = "error-message";
      return false;
    }
    
    if (isSignupMode) {
      if (!validatePassword() || !validatePasswordConfirmation()) {
        return false;
      }
    }
    
    return true;
  }

  // Signup
  function signup() {
    if (!validateForm()) return;
    
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    showLoading(true, "Creating your account...");
    auth.createUserWithEmailAndPassword(email, password)
      .then(() => {
        updateLoadingProgress(50, "Account created! Preparing your quiz...");
        setTimeout(() => {
          document.getElementById('auth-message').innerText = "✅ Signup successful!";
          document.getElementById('auth-message').className = "success-message";
          startQuiz();
        }, 1000);
      })
      .catch(err => {
        showLoading(false);
        document.getElementById('auth-message').textContent = err.message;
        document.getElementById('auth-message').className = "error-message";
      });
  }

  // Login
  function login() {
    if (!validateForm()) return;
    
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    showLoading(true, "Logging in...");
    auth.signInWithEmailAndPassword(email, password)
      .then(() => {
        updateLoadingProgress(50, "Login successful! Loading quiz...");
        setTimeout(() => startQuiz(), 1000);
      })
      .catch(err => {
        showLoading(false);
        document.getElementById('auth-message').textContent = err.message;
        document.getElementById('auth-message').className = "error-message";
      });
  }

  // Start Quiz
  function startQuiz() {
    document.getElementById('auth-section').classList.add('hidden');
    document.getElementById('quiz-section').classList.remove('hidden');
    document.getElementById('result-section').classList.add('hidden');
    document.getElementById('answers-review-section').classList.add('hidden');
    
    currentUser = auth.currentUser;
    document.getElementById('welcome').innerText = `Welcome, ${currentUser.email.split('@')[0]}`;

    // Check if there's a saved quiz in progress
    showLoading(true, "Checking for saved progress...", 30);
    db.ref('userProgress/' + currentUser.uid).once('value').then(snapshot => {
      const savedProgress = snapshot.val();
      
      if (savedProgress && savedProgress.answers && savedProgress.timestamp) {
        // Check if the saved progress is recent (within 1 day)
        const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
        if (savedProgress.timestamp > oneDayAgo) {
          updateLoadingProgress(60, "Saved progress found!");
          setTimeout(() => {
            if (confirm('We found a quiz in progress. Would you like to continue where you left off?')) {
              userAnswers = savedProgress.answers;
              timeLeft = savedProgress.timeLeft || 600;
              loadQuestions(true);
              return;
            } else {
              updateLoadingProgress(70, "Starting new quiz...");
              // Start fresh quiz
              userAnswers = {};
              timeLeft = 600;
              loadQuestions(false);
            }
          }, 1000);
        } else {
          // Start fresh quiz
          updateLoadingProgress(70, "Starting new quiz...");
          userAnswers = {};
          timeLeft = 600;
          loadQuestions(false);
        }
      } else {
        // Start fresh quiz
        updateLoadingProgress(70, "Starting new quiz...");
        userAnswers = {};
        timeLeft = 600;
        loadQuestions(false);
      }
    }).catch(error => {
      showLoading(false);
      console.error("Error checking saved progress:", error);
      // Start fresh quiz even if there's an error
      userAnswers = {};
      timeLeft = 600;
      loadQuestions(false);
    });
  }

  function loadQuestions(restoreProgress) {
    updateLoadingProgress(80, "Loading questions...");
    
    // Fetch questions from Firebase
    db.ref('questions').once('value').then(snapshot => {
      updateLoadingProgress(90, "Preparing your quiz...");
      
      const allQs = Object.values(snapshot.val() || {});
      questions = allQs.sort(() => 0.5 - Math.random()).slice(0, 10);
      
      if (restoreProgress) {
        showQuestions();
        updateQuestionNavigation();
        updateProgressBar();
        navigateToFirstUnanswered();
      } else {
        showQuestions();
        createQuestionNavigation();
        updateProgressBar();
      }
      
      // Add a small delay to ensure smooth transition
      setTimeout(() => {
        showLoading(false);
        startTimer();
      }, 500);
    }).catch(error => {
      showLoading(false);
      console.error("Error loading questions:", error);
      alert("Failed to load questions. Please try again.");
    });
  }

  function showQuestions() {
    const box = document.getElementById('question-box');
    box.innerHTML = '';
    
    if (questions.length === 0) {
      box.innerHTML = '<p>No questions available. Please try again later.</p>';
      return;
    }
    
    const q = questions[currentQuestionIndex];
    box.innerHTML = `
      <p><b>Q${currentQuestionIndex + 1}. ${q.question}</b></p>
      <p><i>${q.explanation || ''}</i></p>
    `;
    
    for (let opt in q.options) {
      const isChecked = userAnswers[currentQuestionIndex] === opt ? 'checked' : '';
      box.innerHTML += `
        <div>
          <input type='radio' name='q${currentQuestionIndex}' value='${opt}' id='opt${opt}' ${isChecked}>
          <label for='opt${opt}'>${q.options[opt]}</label>
        </div>
      `;
    }
    
    // Add event listeners to radio buttons
    const radioButtons = box.querySelectorAll('input[type="radio"]');
    radioButtons.forEach(radio => {
      radio.addEventListener('change', function() {
        userAnswers[currentQuestionIndex] = this.value;
        updateQuestionNavigation();
        updateProgressBar();
        saveProgress();
      });
    });
    
    // Update navigation buttons
    document.getElementById('prev-btn').disabled = currentQuestionIndex === 0;
    document.getElementById('next-btn').disabled = currentQuestionIndex === questions.length - 1;
  }

  function createQuestionNavigation() {
    const nav = document.getElementById('question-navigation');
    nav.innerHTML = '';
    
    questions.forEach((_, index) => {
      const btn = document.createElement('button');
      btn.className = 'btn btn-question';
      btn.textContent = index + 1;
      btn.onclick = () => navigateToQuestion(index);
      
      if (userAnswers[index]) {
        btn.classList.add('btn-answered');
      }
      
      if (index === currentQuestionIndex) {
        btn.classList.add('btn-current');
      }
      
      nav.appendChild(btn);
    });
  }

  function updateQuestionNavigation() {
    const buttons = document.getElementById('question-navigation').querySelectorAll('button');
    buttons.forEach((btn, index) => {
      // Update answered status
      if (userAnswers[index]) {
        btn.classList.add('btn-answered');
      } else {
        btn.classList.remove('btn-answered');
      }
      
      // Update current question highlight
      if (index === currentQuestionIndex) {
        btn.classList.add('btn-current');
      } else {
        btn.classList.remove('btn-current');
      }
    });
  }

  function updateProgressBar() {
    const answeredCount = Object.keys(userAnswers).length;
    const progress = (answeredCount / questions.length) * 100;
    document.getElementById('quiz-progress').style.width = `${progress}%`;
  }

  function navigateQuestion(direction) {
    // Save current answer before navigating
    const selectedOption = document.querySelector(`input[name=q${currentQuestionIndex}]:checked`);
    if (selectedOption) {
      userAnswers[currentQuestionIndex] = selectedOption.value;
      saveProgress();
    }
    
    const newIndex = currentQuestionIndex + direction;
    if (newIndex >= 0 && newIndex < questions.length) {
      currentQuestionIndex = newIndex;
      showQuestions();
      updateQuestionNavigation();
    }
  }

  function navigateToQuestion(index) {
    // Save current answer before navigating
    const selectedOption = document.querySelector(`input[name=q${currentQuestionIndex}]:checked`);
    if (selectedOption) {
      userAnswers[currentQuestionIndex] = selectedOption.value;
      saveProgress();
    }
    
    currentQuestionIndex = index;
    showQuestions();
    updateQuestionNavigation();
  }

  function navigateToFirstUnanswered() {
    for (let i = 0; i < questions.length; i++) {
      if (!userAnswers[i]) {
        currentQuestionIndex = i;
        showQuestions();
        updateQuestionNavigation();
        return;
      }
    }
    // If all questions are answered, go to the first question
    currentQuestionIndex = 0;
    showQuestions();
    updateQuestionNavigation();
  }

  function saveProgress() {
    if (!currentUser) return;
    
    // Show a brief saving indicator without interrupting the user
    const timerElement = document.getElementById('timer');
    const originalText = timerElement.innerHTML;
    timerElement.innerHTML = "Saving...";
    
    db.ref('userProgress/' + currentUser.uid).set({
      answers: userAnswers,
      timeLeft: timeLeft,
      timestamp: Date.now()
    }).then(() => {
      // Briefly show saved status
      timerElement.innerHTML = "Saved!";
      setTimeout(() => {
        const min = Math.floor(timeLeft / 60);
        const sec = timeLeft % 60;
        timerElement.innerHTML = `${min}:${sec.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 60) {
          timerElement.classList.add('timer-warning');
        }
      }, 1000);
    }).catch(error => {
      console.error("Error saving progress:", error);
      timerElement.innerHTML = "Save failed!";
      setTimeout(() => {
        const min = Math.floor(timeLeft / 60);
        const sec = timeLeft % 60;
        timerElement.innerHTML = `${min}:${sec.toString().padStart(2, '0')}`;
      }, 2000);
    });
  }

  function startTimer() {
    clearInterval(timer);
    
    timer = setInterval(() => {
      const min = Math.floor(timeLeft / 60);
      const sec = timeLeft % 60;
      const timerElement = document.getElementById('timer');
      
      timerElement.innerText = `${min}:${sec.toString().padStart(2, '0')}`;
      
      // Add warning when time is running low
      if (timeLeft <= 60) {
        timerElement.classList.add('timer-warning');
      } else {
        timerElement.classList.remove('timer-warning');
      }
      
      if (timeLeft-- <= 0) {
        clearInterval(timer);
        submitQuiz();
      }
      
      // Auto-save progress every 30 seconds
      if (timeLeft % 30 === 0) {
        saveProgress();
      }
    }, 1000);
  }

  function reviewAnswers() {
    const reviewContainer = document.getElementById('answers-review-list');
    reviewContainer.innerHTML = '';
    
    questions.forEach((q, i) => {
      const userAnswer = userAnswers[i];
      const isAnswered = typeof userAnswer !== 'undefined';
      const isCorrect = isAnswered && userAnswer === q.answer;
      
      let statusClass = '';
      if (isAnswered) {
        statusClass = isCorrect ? 'review-correct' : 'review-incorrect';
      } else {
        statusClass = 'review-unanswered';
      }
      
      reviewContainer.innerHTML += `
        <div class="review-item ${statusClass}">
          <p><b>Q${i + 1}. ${q.question}</b></p>
          <p>Your answer: ${isAnswered ? q.options[userAnswer] : 'Not answered'}</p>
          <p class="${isCorrect ? 'success-message' : 'error-message'}">
            ${isAnswered ? (isCorrect ? '✅ Correct' : '❌ Incorrect') : '⏎ Not answered'}
          </p>
          ${!isAnswered || !isCorrect ? `
            <p>Correct answer: ${q.options[q.answer]}</p>
            ${q.explanation ? `<p><i>Explanation: ${q.explanation}</i></p>` : ''}
          ` : ''}
        </div>
      `;
    });
    
    document.getElementById('result-section').classList.add('hidden');
    document.getElementById('answers-review-section').classList.remove('hidden');
  }

  function backToResults() {
    document.getElementById('answers-review-section').classList.add('hidden');
    document.getElementById('result-section').classList.remove('hidden');
  }

  function submitQuiz() {
    clearInterval(timer);
    
    showLoading(true, "Submitting your quiz...", 30);
    
    // Clean up saved progress
    if (currentUser) {
      db.ref('userProgress/' + currentUser.uid).remove();
    }
    
    let score = 0;
    questions.forEach((q, i) => {
      if (userAnswers[i] === q.answer) score++;
    });
    
    updateLoadingProgress(60, "Calculating your score...");
    
    document.getElementById('quiz-section').classList.add('hidden');
    document.getElementById('result-section').classList.remove('hidden');
    document.getElementById('score').innerText = `${score}/${questions.length}`;
    
    // Save score in Firebase
    if (currentUser) {
      updateLoadingProgress(70, "Saving your results...");
      db.ref('scores').push({ 
        email: currentUser.email, 
        name: currentUser.email.split('@')[0], 
        score,
        timestamp: Date.now() 
      }).then(() => {
        updateLoadingProgress(80, "Loading leaderboard...");
        loadLeaderboard();
      });
    } else {
      updateLoadingProgress(80, "Loading leaderboard...");
      loadLeaderboard();
    }
    
    const percentage = (score / questions.length) * 100;
    if (percentage >= 60) {
      document.getElementById('sorry-message').classList.add('hidden');
      document.getElementById('download-btn').classList.remove('hidden');
      updateLoadingProgress(90, "Generating your certificate...");
      setTimeout(() => {
        generateCertificate(currentUser.email.split('@')[0], score);
        showLoading(false);
      }, 1000);
    } else {
      document.getElementById('certificate-canvas').classList.add('hidden');
      document.getElementById('download-btn').classList.add('hidden');
      const msg = document.getElementById('sorry-message');
      msg.classList.remove('hidden');
      msg.innerHTML = `😞 Sorry! You scored ${percentage.toFixed(1)}% but need 60% or higher for a certificate.<br>
                       <button class="btn" onclick="retryQuiz()" style="margin-top: 10px;">Try Again</button>`;
      showLoading(false);
    }
  }

  function generateCertificate(name, score) {
    const canvas = document.getElementById('certificate-canvas');
    canvas.classList.remove('hidden');
    const ctx = canvas.getContext('2d');

    // Background
    ctx.fillStyle = '#f9f9f9';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Border
    ctx.strokeStyle = '#0073b1';
    ctx.lineWidth = 20;
    ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);
    
    // Decorative elements
    ctx.fillStyle = 'rgba(0, 115, 177, 0.1)';
    ctx.beginPath();
    ctx.arc(100, 100, 50, 0, Math.PI * 2);
    ctx.arc(canvas.width - 100, 100, 50, 0, Math.PI * 2);
    ctx.arc(100, canvas.height - 100, 50, 0, Math.PI * 2);
    ctx.arc(canvas.width - 100, canvas.height - 100, 50, 0, Math.PI * 2);
    ctx.fill();
    
    // Title
    ctx.fillStyle = '#0073b1';
    ctx.font = 'bold 40px Roboto';
    ctx.textAlign = 'center';
    ctx.fillText('Certificate of Achievement', canvas.width / 2, 120);
    
    // Subtitle
    ctx.fillStyle = '#333';
    ctx.font = '30px Roboto';
    ctx.fillText('Procurement & Supply Chain Quiz', canvas.width / 2, 170);
    
    // Presented to
    ctx.font = '28px Roboto';
    ctx.fillText('This certificate is presented to', canvas.width / 2, 240);
    
    // Name
    ctx.fillStyle = '#0073b1';
    ctx.font = 'bold 36px Roboto';
    ctx.fillText(name, canvas.width / 2, 300);
    
    // Score
    ctx.fillStyle = '#333';
    ctx.font = '28px Roboto';
    ctx.fillText(`with a score of ${score} out of ${questions.length}`, canvas.width / 2, 350);
    
    // Date
    const date = new Date().toLocaleDateString();
    ctx.font = '20px Roboto';
    ctx.fillText(`Date: ${date}`, canvas.width / 2, 500);
    
    // Signature line
    ctx.beginPath();
    ctx.moveTo(canvas.width / 2 - 100, 550);
    ctx.lineTo(canvas.width / 2 + 100, 550);
    ctx.strokeStyle = '#333';
    ctx.lineWidth = 1;
    ctx.stroke();
    
    ctx.fillStyle = '#333';
    ctx.font = '18px Roboto';
    ctx.fillText('Quiz Administrator', canvas.width / 2, 580);
  }

  function downloadCertificate() {
    const canvas = document.getElementById('certificate-canvas');
    if (!canvas.classList.contains('hidden')) {
      showLoading(true, "Preparing your certificate for download...", 95);
      setTimeout(() => {
        const link = document.createElement('a');
        link.download = `procurement_certificate_${currentUser.email.split('@')[0]}.png`;
        link.href = canvas.toDataURL();
        link.click();
        showLoading(false);
      }, 500);
    } else {
      alert("No certificate to download!");
    }
  }

  function retryQuiz() {
    showLoading(true, "Preparing a new quiz for you...", 50);
    
    document.getElementById('result-section').classList.add('hidden');
    document.getElementById('quiz-section').classList.remove('hidden');
    document.getElementById('certificate-canvas').classList.add('hidden');
    document.getElementById('sorry-message').classList.add('hidden');
    
    // Reset quiz state
    userAnswers = {};
    currentQuestionIndex = 0;
    timeLeft = 600;
    
    setTimeout(() => {
      showQuestions();
      createQuestionNavigation();
      updateProgressBar();
      startTimer();
      showLoading(false);
    }, 1000);
  }

  function loadLeaderboard() {
    db.ref('scores').once('value', snapshot => {
      const list = document.getElementById('leaderboard-list');
      list.innerHTML = '';
      const allScores = [];
      
      // Collect all scores
      snapshot.forEach(s => {
        const data = s.val();
        allScores.push(data);
      });
      
      // Group by user and get their highest score
      const userBestScores = {};
      allScores.forEach(score => {
        if (!userBestScores[score.email] || score.score > userBestScores[score.email].score) {
          userBestScores[score.email] = score;
        }
      });
      
      // Convert to array and sort
      const topScores = Object.values(userBestScores)
        .sort((a, b) => {
          // First by score (descending)
          if (b.score !== a.score) {
            return b.score - a.score;
          }
          // Then by timestamp (ascending - earlier attempts rank higher if scores are equal)
          return a.timestamp - b.timestamp;
        })
        .slice(0, 50); // Top 50
      
      if (topScores.length === 0) {
        list.innerHTML = '<p>No scores yet. Be the first to complete the quiz!</p>';
        return;
      }
      
      // Display the leaderboard
      topScores.forEach((score, index) => {
        const rank = index + 1;
        let rankEmoji = '';
        
        // Only show medals for top 3
        if (rank === 1) rankEmoji = '🥇';
        else if (rank === 2) rankEmoji = '🥈';
        else if (rank === 3) rankEmoji = '🥉';
        
        const item = document.createElement('div');
        item.className = 'leaderboard-item';
        if (rank <= 3) item.classList.add('top-three');
        
        item.innerHTML = `
          <div class="leaderboard-rank">${rankEmoji || rank}</div>
          <div class="leaderboard-name">${score.name}</div>
          <div class="leaderboard-score">${score.score}/${questions.length}</div>
        `;
        
        list.appendChild(item);
      });
    });
  }

  function shareLinkedIn() { 
    const score = document.getElementById('score').innerText;
    window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(window.location.href)}&summary=${encodeURIComponent('I scored ' + score + ' in the Procurement & Supply Chain Quiz!')}`, '_blank');
  }
  
  function shareFB() { 
    const score = document.getElementById('score').innerText;
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodeURIComponent('I scored ' + score + ' in the Procurement & Supply Chain Quiz!')}`, '_blank');
  }
  
  function shareTwitter() { 
    const score = document.getElementById('score').innerText;
    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent('I scored ' + score + ' in the Procurement & Supply Chain Quiz!')}&url=${encodeURIComponent(window.location.href)}`, '_blank');
  }
  
  function shareWhatsApp() { 
    const score = document.getElementById('score').innerText;
    window.open(`https://wa.me/?text=${encodeURIComponent('I scored ' + score + ' in the Procurement & Supply Chain Quiz! ' + window.location.href)}`, '_blank');
  }
</script>
</body>
</html>